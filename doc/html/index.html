<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BEL3 ESS task: XMC4500 acceleration sensor task - Werner Egermann, Helmut Resch - BEL3</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="fhtw.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BEL3 ESS task
   &#160;<span id="projectnumber">version 1.0 overhanding</span>
   </div>
   <div id="projectbrief">I2C acceleration sensor with GUI</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">XMC4500 acceleration sensor task - Werner Egermann, Helmut Resch - BEL3 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>project description</h1>
<h2>definition of task</h2>
<p><a href="https://cis.technikum-wien.at/documents/bel/3/ess/semesterplan/tasks/tasks.html">https://cis.technikum-wien.at/documents/bel/3/ess/semesterplan/tasks/tasks.html</a></p>
<table class="doxtable">
<tr>
<th>screenshot task description  </th></tr>
<tr>
<td><div class="image">
<img src="../../pictures/taskdescriptionCIS.png" alt="alt text" title="PWM calculations"/>
</div>
 </td></tr>
</table>
<h1>realized task</h1>
<p>The realized task is generic and a "proof of concept" for some possibilities with the chosen <b>Adafruit LIS3DH Triple-Axis Accelerometer</b>.</p>
<p>As described in the definition the task is split into 2 major parts, the uC software for the Infineon XMC4500 and the GUI for the PC realized with GTK-3 + C and Python 3 + Pygame + Matplotlib.</p>
<p>The uC software includes a simple (bidirectional) UART communication protocol, libraries + drivers for</p>
<ul>
<li>I2C communication</li>
<li>sensor communication</li>
<li>servocontrol</li>
<li>buttons + LED control</li>
</ul>
<p>The raw data from the accelerometer, the 6D position and statistics can be requested by the PC application and the values are shown on the GUI. The rotation angles for all 3 axes and the pitch and roll angle are calculated within the PC application and shown on the GUI, also a simple frefall detection is include.</p>
<p>Within the GUI a statistic package (sent sensor readings, data packages, errors) can be requested, the data can be logged to harddisk, triggers for acceleration can be set and various settings like activating UART connection, requesting data from sensors, activating servos, changing between measurement averaging and "thresholding" for servo settings can be done.</p>
<p>BUTTON1 is used to switch on/off the servos and BUTTON2 is used to choose averaging/thersholding.</p>
<p>LED1 represents the PWM "percentage" of one servo, LED2 is on when GUI and XMC are connected, and toggles according when data is requested by the GUI.</p>
<p>2 python scripts can be started from the GUI, one to show possibilities for sprite rotation with the pygame library and one to show a graph for the accelerations.</p>
<h1>XMC software</h1>
<h2>folders and files</h2>
<p>The code is located in the folders</p>
<ul>
<li>/src/ - all C source files</li>
<li>/inc/ - all C header files</li>
</ul>
<p>Details find in section "Files" in the doxygen documentation and further details inside the source code.</p>
<h2>dependency graph XMC software</h2>
<p>The graph shows the app &gt; library &gt; driver structure of all source code.</p>
<table class="doxtable">
<tr>
<th>dependency graph  </th></tr>
<tr>
<td><div class="image">
<img src="../../pictures/dependency_graph_XMC.png" alt="alt text" title="XMC software"/>
</div>
 </td></tr>
</table>
<h2>settings for the hardware PWM and angle correction of sensor</h2>
<table class="doxtable">
<tr>
<th>calculations for PWM signal servos and necessary settings for counter and prescaler  </th></tr>
<tr>
<td><div class="image">
<img src="../../pictures/PWM_servo_calc.png" alt="alt text" title="PWM calculations"/>
</div>
 </td></tr>
</table>
<table class="doxtable">
<tr>
<th>calculation for angle correction sensor  </th></tr>
<tr>
<td>sensor „Resch“ shows pitch angle up to maximum 85° - other direction seems ok with minimum -89° </td></tr>
</table>
<h2>external code</h2>
<ul>
<li><a class="el" href="lis3dh__driver_8c.html" title="lis3dh driver ">lis3dh_driver.c</a> and <a class="el" href="lis3dh__driver_8h.html" title="lis3dh driver header ">lis3dh_driver.h</a> provided by ST Microelectronics</li>
<li><a class="el" href="xmc4500__i2c__lib_8c.html">xmc4500_i2c_lib.c</a> and <a class="el" href="xmc4500__i2c__lib_8h.html">xmc4500_i2c_lib.h</a> provided by FHTW</li>
<li><a class="el" href="xmc4500__uart__lib_8c.html">xmc4500_uart_lib.c</a> and <a class="el" href="xmc4500__uart__lib_8h.html">xmc4500_uart_lib.h</a> provided by FHTW</li>
<li><a class="el" href="debug__lib_8c.html" title="This library retargets the printf() function to generate output via the SWD DEBUG interface...">debug_lib.c</a> and <a class="el" href="debug__lib_8h.html" title="This library retargets the printf() function to generate output via the SWD DEBUG interface...">debug_lib.h</a> provided by FHTW</li>
<li>Makefile provided by FHTW</li>
</ul>
<p>Thanks for this support!</p>
<h2>testing</h2>
<h3>Source code test with cppcheck, only minor comments, external code excluded</h3>
<pre class="fragment">cppcheck --enable=all --std=posix --std=c99 --force --template=gcc ./inc/3Daccel_app.h ./inc/3Daccel_out_driver.h ./inc/3Daccel_out_library.h ./inc/lis3dh_library.h ./inc/servo_driver.h ./inc/servo_library.h ./src/3Daccel_app.c ./src/3Daccel_out_driver.c ./src/3Daccel_out_library.c ./src/lis3dh_library.c ./src/servo_driver.c ./src/servo_library.c

Checking inc/3Daccel_app.h ...
1/12 files checked 0% done
Checking inc/3Daccel_out_driver.h ...
2/12 files checked 2% done
Checking inc/3Daccel_out_library.h ...
3/12 files checked 9% done
Checking inc/lis3dh_library.h ...
4/12 files checked 11% done
Checking inc/servo_driver.h ...
5/12 files checked 13% done
Checking inc/servo_library.h ...
6/12 files checked 14% done
Checking src/3Daccel_app.c ...
Checking src/3Daccel_app.c: DEBUG...
7/12 files checked 28% done
Checking src/3Daccel_out_driver.c ...
8/12 files checked 37% done
Checking src/3Daccel_out_library.c ...
src/3Daccel_out_library.c:63: style: The scope of the variable 'ticks' can be reduced.
src/3Daccel_out_library.c:65: style: The scope of the variable 'i' can be reduced.
src/3Daccel_out_library.c:66: style: The scope of the variable 'smoothSignal1' can be reduced.
src/3Daccel_out_library.c:66: style: The scope of the variable 'smoothSignal2' can be reduced.
Checking src/3Daccel_out_library.c: DEBUG...
9/12 files checked 67% done
Checking src/lis3dh_library.c ...
10/12 files checked 84% done
Checking src/servo_driver.c ...
11/12 files checked 97% done
Checking src/servo_library.c ...
12/12 files checked 100% done
src/3Daccel_out_library.c:61: style: The function 'SysTick_Handler' is never used.
src/3Daccel_out_library.c:276: style: The function 'getDouble' is never used.
:: information: Cppcheck cannot find all the include files (use --check-config for details)
</pre><h3>Source code test with splint, only minor comments, external code excluded</h3>
<p>splint +posixlib -unrecog -standard +trytorecover -preproc -predboolint +matchanyintegral -exportlocal ./inc/3Daccel_app.h ./inc/3Daccel_out_driver.h ./inc/3Daccel_out_library.h ./inc/lis3dh_library.h ./inc/servo_driver.h ./inc/servo_library.h ./src/3Daccel_app.c ./src/3Daccel_out_driver.c ./src/3Daccel_out_library.c ./src/lis3dh_library.c ./src/servo_driver.c ./src/servo_library.c </p><pre class="fragment">Splint 3.1.2 --- 04 Aug 2017
src/lis3dh_library.c: (in function initMEMSsensor)
src/lis3dh_library.c:60:31: Function LIS3DH_SetAxis expects arg 1 to be
    LIS3DH_Axis_t gets enum { LIS3DH_X_ENABLE, LIS3DH_X_DISABLE,
    LIS3DH_Y_ENABLE, ..., LIS3DH_Z_DISABLE }:
    LIS3DH_X_ENABLE | LIS3DH_Y_ENABLE | LIS3DH_Z_ENABLE
  Types are incompatible. (Use -type to inhibit warning)
src/lis3dh_library.c: (in function configMEMSsensor)
src/lis3dh_library.c:86:32: Function LIS3DH_SetInt1Threshold expects arg 1 to
                               be u8_t gets int: 20
src/lis3dh_library.c: (in function get6Dposition)
src/lis3dh_library.c:165:37: Function LIS3DH_Get6DPosition expects arg 1 to be
                                u8_t * gets uint8_t *: &amp;position
src/lis3dh_library.c: (in function getAxesRawData)
src/lis3dh_library.c:233:37: Passed storage data contains 3 undefined fields:
                                AXIS_X, AXIS_Y, AXIS_Z
  Storage derivable from a parameter, return value or global is not defined.
  Use /*@out@*/ to denote passed or returned storage which need not be defined.
  (Use -compdef to inhibit warning)

Finished checking --- 4 code warnings
</pre><p>2 function in 3D_accel_out_driver.c had to be excluded for splint to avoid parse errors </p><pre class="fragment">void outputInitXMC(void)
{
    XMC_GPIO_CONFIG_t config_out;
    config_out.mode = XMC_GPIO_MODE_OUTPUT_PUSH_PULL;
    config_out.output_level = XMC_GPIO_OUTPUT_LEVEL_LOW;
    config_out.output_strength = XMC_GPIO_OUTPUT_STRENGTH_WEAK;
    XMC_GPIO_Init(LED1, &amp;config_out);
}

void inputInitXMC()
{
    XMC_GPIO_CONFIG_t config_in;
    config_in.mode = XMC_GPIO_MODE_INPUT_INVERTED_PULL_UP;
    XMC_GPIO_Init(BUTTON1, &amp;config_in);
    XMC_GPIO_Init(BUTTON2, &amp;config_in);
}
</pre><h1>XMC hardware</h1>
<h2>description</h2>
<ul>
<li>/sensordocu/ - all available documentation from ST Microelectronics</li>
</ul>
<p><br />
</p>
<ul>
<li>sensor is connected via I2C and 3V3 to XMC, see <a class="el" href="lis3dh__driver_8c.html" title="lis3dh driver ">lis3dh_driver.c</a> and <a class="el" href="lis3dh__driver_8h.html" title="lis3dh driver header ">lis3dh_driver.h</a> regarding used pins and hardware adress.</li>
</ul>
<table class="doxtable">
<tr>
<th>sensor  </th></tr>
<tr>
<td><div class="image">
<img src="../../pictures/sensor.png" alt="alt text" title="picture sensor"/>
</div>
 </td></tr>
</table>
<ul>
<li>XMC connector includes 4k7 pullup resistors for I2C, signal and power connections, terminal blocks for external 5V power source servos and terminal blocks to connected signals and power</li>
</ul>
<table class="doxtable">
<tr>
<th>XMC connector  </th></tr>
<tr>
<td><div class="image">
<img src="../../pictures/XMCconnector.png" alt="alt text" title="XMC connector"/>
</div>
 </td></tr>
</table>
<ul>
<li>external power source</li>
</ul>
<p>The servos are supplied by an external 5V power source.</p>
<table class="doxtable">
<tr>
<th>power  </th></tr>
<tr>
<td><div class="image">
<img src="../../pictures/power.png" alt="alt text" title="power"/>
</div>
 </td></tr>
</table>
<ul>
<li>servos</li>
</ul>
<p>Simple analog servos from Conrad used for the hardware</p>
<table class="doxtable">
<tr>
<th>servos  </th></tr>
<tr>
<td><div class="image">
<img src="../../pictures/servo.png" alt="alt text" title="servos"/>
</div>
 </td></tr>
</table>
<ul>
<li>big picture</li>
</ul>
<p>Simple wooden construction for the servos</p>
<table class="doxtable">
<tr>
<th>big picture  </th></tr>
<tr>
<td><div class="image">
<img src="../../pictures/viewall.png" alt="alt text" title="bigpicture"/>
</div>
 </td></tr>
</table>
<h2>testing</h2>
<p>oscilloscope screenshots of PWM signal</p>
<table class="doxtable">
<tr>
<th>-90° / 0° </th><th>0° </th><th>+90° / 180°  </th></tr>
<tr>
<td><div class="image">
<img src="../../pictures/PWM3.png" alt="alt text" title="PWM 3%"/>
</div>
 </td><td><div class="image">
<img src="../../pictures/PWM7.png" alt="alt text" title="PWM 7%"/>
</div>
 </td><td><div class="image">
<img src="../../pictures/PWM12.png" alt="alt text" title="PWM 12%"/>
</div>
 </td></tr>
</table>
<h1>PC GUI software</h1>
<h2>folders and files</h2>
<p>The code is located in the folders</p>
<ul>
<li>/gtk_GUI/ - all GTK GUI C source and header files</li>
<li>/python/ - all PYTHON scripts as mentiond in the description and all necessary pictures</li>
<li>/pictures/ - all pictures for <a class="el" href="README_8md.html">README.md</a> file</li>
</ul>
<p>Details find in section "Files" in the doxygen documentation and further details inside the source code.</p>
<h2>description</h2>
<p>Graph of all GUI function calls.</p>
<table class="doxtable">
<tr>
<th>functions graph  </th></tr>
<tr>
<td><div class="image">
<img src="../../pictures/function_graph_GUI.png" alt="alt text" title="GUI software"/>
</div>
 </td></tr>
</table>
<h2>GUI overview</h2>
<table class="doxtable">
<tr>
<th>GUI overview after start  </th></tr>
<tr>
<td><div class="image">
<img src="../../pictures/GUI_screenshot_start.png" alt="alt text" title="GUI view start"/>
</div>
 </td></tr>
</table>
<table class="doxtable">
<tr>
<th>GUI description  </th></tr>
<tr>
<td><div class="image">
<img src="../../pictures/GUI_screenshot_commented.png" alt="alt text" title="GUI view commented"/>
</div>
 </td></tr>
</table>
<p>(0) highlights values which have to be set before connection</p>
<p>(1) connect</p>
<p>(2) start transmission</p>
<p>GTK buttons are set active or inactive as needed, feel free to experiment!</p>
<h2>external code</h2>
<ul>
<li><a class="el" href="rs232_8c.html">rs232.c</a> and <a class="el" href="rs232_8h.html">rs232.h</a> provided by FHTW</li>
<li>Makefile provided by FHTW</li>
</ul>
<p>Again thanks!</p>
<h3>testing</h3>
<p>For the GTK GUI only cppcheck done. </p><pre class="fragment">cppcheck --enable=all --std=posix --std=c99 --force --template=gcc 3DacceltaskGUI.c 3DacceltaskGUI.h menucallbacks.c menucallbacks.h

Checking 3DacceltaskGUI.c ...
Checking 3DacceltaskGUI.c: __FreeBSD__;__linux__...
1/4 files checked 25% done
Checking 3DacceltaskGUI.h ...
Checking 3DacceltaskGUI.h: __FreeBSD__;__linux__...
2/4 files checked 29% done
Checking menucallbacks.c ...
menucallbacks.c:488: style: The scope of the variable 'mode' can be reduced.
menucallbacks.c:491: style: The scope of the variable 'requestConnection' can be reduced.
menucallbacks.c:560: style: The scope of the variable 'requestServoOn' can be reduced.
menucallbacks.c:597: style: The scope of the variable 'requestAveragePWM' can be reduced.
Checking menucallbacks.c: __FreeBSD__;__linux__...
3/4 files checked 95% done
Checking menucallbacks.h ...
Checking menucallbacks.h: __FreeBSD__;__linux__...
4/4 files checked 100% done
:: information: Cppcheck cannot find all the include files (use --check-config for details)
</pre><h1>Conclusion</h1>
<p>Interesting and demanding task - especially the GUI. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
